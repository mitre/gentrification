---
title: "Census-Based Gentrification Methods"
output: 
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float: true
runtime: shiny
bibliography: references.bib
---

```{r setup, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyr)
library(tmap)
library(tigris)
library(sf)
library(MITREShiny)

setwd("~/Documents/MIP/gentrification/notebooks")
tracts <- readRDS("../outputs/geo_tracts.RDS")

combined_indicators <- readRDS("../outputs/combined_indicators.RDS") %>%
  mutate(YEAR = ifelse(YEAR == 2019, 2020, YEAR),
         STATE_FIP = substr(GEOID, 1,2),
         COUNTY_FIP = substr(GEOID, 3,5))

fipsnames_cw <- unique(combined_indicators[,c("STATE", "COUNTY", "STATE_FIP", "COUNTY_FIP")])

theme_set(theme_minimal())
```

## Introduction

The purpose of this document is to help users understand how the measures and indicators used in census-based gentrification affect which areas are classified as gentrified. In even as early as 1986, George Galster & Stephen Peacock reported "great sensitivity in the number and location of gentrified tracts to the definition chosen and stringency applied", when examining areal changes in Philadelphia between 1970 - 1980. [@galster1986] This definition explorer document hopes to visualize and elucidate some of those sensitivities.

Census-based gentrification definitions have often been used as a quantitative, quick way approximate the difficult concept of gentrification.

However, this has been little consensus among researchers in defining gentrification, much less in operationalizing the definition. In a systematic review of gentrification definitions used in epidemiologic research, 18 different indicators were used to capture and measure gentrification including Median Household Income, Education, Rent, Race, Home Value, Poverty, etc. [@Bhavsar2020]

Two common concepts are used in defining gentrification.

1.  Neighborhoods are **eligible** to be gentrified.
2.  Neighborhoods that meet threshold criteria are **determined** to be gentrified.

Indicators can be used to define eligibility, determination, or both.

In addition to areal indicators, time period of evaluation and reference geographic region are also important decisions which may impact the quantification of tracts as gentrified.

## Explore

The three most commonly used indicators used in quantitative definitions of gentrification are:

-   Median Household Income

-   Median Rent

-   Education (% with Bachelors Degree)

```{r core-explore, echo=FALSE}


  inputPanel(
    sliderInput("range", label = "Select Year Range:",
                min = 1970, max = 2020, value = c(2000, 2020), step = 10, sep = ""),
    
    selectInput("state", label = "Choose a State:",
                choices = sort(unique(combined_indicators$STATE)), selected = "Oregon"),
    
    renderUI({
      counties <- unique(combined_indicators[combined_indicators$STATE == input$state, "COUNTY"])
      selectInput("county", label = "Choose a County:",
                  choices = counties, selected = "Multnomah")
    })
  )
  
renderPlot({
  
  combined_indicators %>%
    select(YEAR, STATE, COUNTY, 
           `Median Rent`, 
           `Median Household Income, Total`,
           `Percent with 4-year College Degree or More`) %>%
    gather(key = "Feature", value = "Value", -YEAR, -STATE, -COUNTY) %>%
    filter(YEAR %in% input$range,
           STATE == input$state,
           COUNTY == input$county) %>%
    ggplot(aes(x = Value)) +
    geom_histogram(aes(fill = as.factor(YEAR)),
                   alpha = 0.6, position = "dodge") +
    facet_wrap(~ Feature, nrow = 1, ncol = 4, scales="free") +
    labs(fill = "Year",
         y = "# of Tracts") +
    theme(legend.position = "bottom",
          aspect.ratio = 0.8)


})

```

Eligibility threshold characterizes which set of tracts can be considered candidates for gentrification.

Determination thresholds characterize what change is significant to capture neighborhood change.

### Median Household Income

```{r mhi, echo=FALSE}

  inputPanel(
    sliderInput("eligibility_mhi", "Select Elgibility Threshold",
                min = 0, max = 1, value = 0.5, step = 0.1), 
    
    sliderInput("determination_mhi", "Select Determination Threshold",
                min = 0, max = 1, value = 0.5, step = 0.1)
  )
  
  
    start_data <- reactive({ 
      combined_indicators %>%
        filter(YEAR == input$range[1],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_start = percent_rank(`Median Household Income, Total`))
    })
    
    end_data <- reactive({  
      combined_indicators %>%
        filter(YEAR == input$range[2],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_end = percent_rank(`Median Household Income, Total`))
    })
    
    labelled_data_mhi <- reactive({
      start_data() %>%
        inner_join(end_data(), by = "GEOID") %>% 
        select(Rank_start, Rank_end, GEOID, `Total Pop.y`) %>%
        mutate(Eligible = ifelse(Rank_start < input$eligibility_mhi, "Yes", "No"),
               Determination = ifelse(Rank_end > input$determination_mhi & Eligible == "Yes",
                                      "Yes", "No"),
               `Gentrification Indicator (MHI)` = ifelse(Eligible == "Yes" & Determination == "Yes", 
                                   "Yes", "No"))
    })
  

    
    fips <- reactive({fipsnames_cw[fipsnames_cw$STATE == input$state & 
                             fipsnames_cw$COUNTY == input$county,]
    })
    
    tract_subset_mhi <- reactive({tracts %>%
        filter(STATEFP == fips()$STATE_FIP,
               COUNTYFP == fips()$COUNTY_FIP) %>%
        merge(.,labelled_data_mhi(), by = "GEOID")
      })
    
    splitLayout(
      renderPlot({
        labelled_data_mhi() %>%
          ggplot(aes(x = Rank_start, y = Rank_end)) +
          geom_point(aes(color = Eligible, alpha = Determination, size = `Total Pop.y`)) +
          scale_alpha_manual(values = c(0.3, 1))+ 
          theme(aspect.ratio = 1) +
          labs(x = "Tract Percentile Rank in Start Decade",
               y = "Tract Percentile Rank in End Decade",
               size = "Population in End Decade")
        
      }),
      
      renderTmap({
        
        tm_shape(tract_subset_mhi()) +
          tm_polygons(col = "Gentrification Indicator (MHI)",
                      alpha = 0.6)
      })
      
    )
    
```

### Median Rent Indicator

Including a Median Rent Indicator means that only tracts that started with a median rental value below some X threshold were eligible to gentrify, and if among those tracts, ended up above the top percentile

```{r rent, echo=FALSE}
  inputPanel(
    sliderInput("eligibility_rent", "Select Eligibility Threshold",
                min = 0, max = 1, value = 0.5, step = 0.1), 
    
    sliderInput("determination_rent", "Select Determination Threshold",
                min = 0, max = 1, value = 0.5, step = 0.1)
  )
  
  
    start_data_rent <- reactive({ 
      combined_indicators %>%
        filter(YEAR == input$range[1],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_start = percent_rank(`Median Rent`))
    })
    
    end_data_rent <- reactive({  
      combined_indicators %>%
        filter(YEAR == input$range[2],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_end = percent_rank(`Median Rent`))
    })
    
    labelled_data_rent <- reactive({
      start_data_rent() %>%
        inner_join(end_data_rent(), by = "GEOID") %>% 
        select(Rank_start, Rank_end, GEOID, `Total Pop.y`) %>%
        mutate(Eligible = ifelse(Rank_start < input$eligibility_rent, "Yes", "No"),
               Determination = ifelse(Rank_end > input$determination_rent & Eligible == "Yes",
                                      "Yes", "No"),
               `Gentrification Indicator (Rent)` = ifelse(Eligible == "Yes" & Determination == "Yes", 
                                   "Yes", "No"))
    })
  
    tract_subset_rent <- reactive({tracts %>%
        filter(STATEFP == fips()$STATE_FIP,
               COUNTYFP == fips()$COUNTY_FIP) %>%
        merge(.,labelled_data_rent(), by = "GEOID")
    })
    
    splitLayout(
      renderPlot({ 
        labelled_data_rent() %>%
          ggplot(aes(x = Rank_start, y = Rank_end)) +
          geom_point(aes(color = Eligible, alpha = Determination, size = `Total Pop.y`)) +
          scale_alpha_manual(values = c(0.3, 1))+ 
          theme(aspect.ratio = 1) +
          labs(x = "Tract Percentile Rank in Start Decade",
               y = "Tract Percentile Rank in End Decade",
               size = "Population in End Decade")
        
      }),
      
      renderTmap({
        
        tm_shape(tract_subset_rent()) +
          tm_polygons(col = "Gentrification Indicator (Rent)",
                      alpha = 0.4)
      })
    )
```

### Education Indicator

Including an Education Indicator means that only tracts with a population above a pre-defined percentage threshold of residents with a 4-year College Degree or More can be considered gentrified.

```{r edu, echo=FALSE}
  inputPanel(
    sliderInput("determination_edu", "Select Determination Threshold",
                min = 0, max = 1, value = 0.66, step = 0.1)
  )
  
  
    start_data_edu <- reactive({ 
      combined_indicators %>%
        filter(YEAR == input$range[1],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_start = percent_rank(`Percent with 4-year College Degree or More`))
    })
    
    end_data_edu <- reactive({  
      combined_indicators %>%
        filter(YEAR == input$range[2],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_end = percent_rank(`Percent with 4-year College Degree or More`))
    })
    
    labelled_data_edu <- reactive({
      start_data_edu() %>%
        inner_join(end_data_edu(), by = "GEOID") %>% 
        select(Rank_start, Rank_end, GEOID, `Total Pop.y`) %>%
        mutate(Determination = ifelse(Rank_end > input$determination_edu,
                                      "Yes", "No"),
               `Gentrification Indicator (Education)` = ifelse(Determination == "Yes", 
                                   "Yes", "No"))
    })
  
    tract_subset_edu <- reactive({tracts %>%
        filter(STATEFP == fips()$STATE_FIP,
               COUNTYFP == fips()$COUNTY_FIP) %>%
        merge(.,labelled_data_edu(), by = "GEOID")
    })
    
    splitLayout(
      renderPlot({ 
        labelled_data_edu() %>%
          ggplot(aes(x = Rank_start, y = Rank_end)) +
          geom_point(aes(color = Determination, alpha = Determination, size = `Total Pop.y`)) +
          scale_alpha_manual(values = c(0.3, 1))+ 
          theme(aspect.ratio = 1) +
          labs(x = "Tract Percentile Rank in Start Decade",
               y = "Tract Percentile Rank in End Decade",
               size = "Population in End Decade")
        
      }),
      
      renderTmap({
        tm_shape(tract_subset_edu()) +
          tm_polygons(col = "Gentrification Indicator (Education)",
                      alpha = 0.4)
      })
    )
```

### Additional Indicators

#### Median Home Value Indicator

```{r mhv, echo=FALSE, collapse=TRUE}
  inputPanel(
    sliderInput("eligibility_mhv", "Select Eligibility Threshold",
                min = 0, max = 1, value = 0.5, step = 0.1), 
    
    sliderInput("determination_mhv", "Select Determination Threshold",
                min = 0, max = 1, value = 0.5, step = 0.1)
  )
  
  
    start_data_mhv <- reactive({ 
      combined_indicators %>%
        filter(YEAR == input$range[1],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_start = percent_rank(`Median Home Value`))
    })
    
    end_data_mhv <- reactive({  
      combined_indicators %>%
        filter(YEAR == input$range[2],
               STATE == input$state,
               COUNTY == input$county) %>%
        mutate(Rank_end = percent_rank(`Median Home Value`))
    })
    
    labelled_data_mhv <- reactive({
      start_data_mhv() %>%
        inner_join(end_data_mhv(), by = "GEOID") %>% 
        select(Rank_start, Rank_end, GEOID, `Total Pop.y`) %>%
        mutate(Eligible = ifelse(Rank_start < input$eligibility_mhv, "Yes", "No"),
               Determination = ifelse(Rank_end > input$determination_mhv & Eligible == "Yes",
                                      "Yes", "No"),
               `Gentrification Indicator (MHV)` = ifelse(Eligible == "Yes" & Determination == "Yes", 
                                   "Yes", "No"))
    })
  
    tract_subset_mhv <- reactive({tracts %>%
        filter(STATEFP == fips()$STATE_FIP,
               COUNTYFP == fips()$COUNTY_FIP) %>%
        merge(.,labelled_data_mhv(), by = "GEOID")
    })
    
    splitLayout(
      renderPlot({ 
        labelled_data_mhv() %>%
          ggplot(aes(x = Rank_start, y = Rank_end)) +
          geom_point(aes(color = Eligible, alpha = Determination, size = `Total Pop.y`)) +
          scale_alpha_manual(values = c(0.3, 1))+ 
          theme(aspect.ratio = 1) +
          labs(x = "Tract Percentile Rank in Start Decade",
               y = "Tract Percentile Rank in End Decade",
               size = "Population in End Decade")
        
      }),
      
      renderTmap({
        
        tm_shape(tract_subset_mhv()) +
          tm_polygons(col = "Gentrification Indicator (MHV)",
                      alpha = 0.4)
      })
    )
```

## Output and Download

Census Tracts that meet the determination thresholds in Median Household Income, Median Rent, and Education are consequently classified as gentrified.

```{r, echo=FALSE}

inputPanel(
  checkboxInput("mhi", "Include Median Household Income Indicator", value = TRUE),
  
  checkboxInput("rent", "Include Median Rent Indicator", value = TRUE),
  
  checkboxInput("edu", "Include Education Indicator", value = TRUE),
  
  checkboxInput("mhv", "Include Median Home Value Indicator", value = FALSE)

)


  
  starter <- tibble(GEOID = "")
  
  right_join_if_true <- function(left_data, right_data, by, suffix, bool){
    if (bool) {
      right_join(left_data, right_data, by = by, suffix = suffix)
    } else {left_data}
  }
  
  indicators <- reactive({
    starter %>%
      right_join_if_true(labelled_data_mhi(), by = "GEOID", suffix = c("", " MHI"), input$mhi) %>%
      right_join_if_true(labelled_data_rent(), by = "GEOID", suffix = c("", " Rent"), input$rent) %>%
      right_join_if_true(labelled_data_edu(), by = "GEOID", suffix = c("", " Edu"), input$edu) %>%
      right_join_if_true(labelled_data_mhv(), by = "GEOID", suffix = c("", " MHV"), input$mhv) %>%
      select(GEOID, starts_with("Gentrification Indicator")) %>%
      mutate(`Number of Indicators` = rowSums(.[,-1] == "Yes"))
  })
  


 combined_tract_subset <- reactive({tracts %>%
        filter(STATEFP == fips()$STATE_FIP,
               COUNTYFP == fips()$COUNTY_FIP) %>%
        merge(.,indicators(), by = "GEOID")
    })

 
 renderTmap({
        tm_shape(combined_tract_subset()) +
          tm_polygons(col = "Number of Indicators",
                      alpha = 0.4)
      })
 
  renderDataTable({
   indicators()
 })
```
